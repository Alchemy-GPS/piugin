<?php/** * 订单管理 */if(!defined('IN_DISCUZ') || !defined('IN_ADMINCP')) {    exit('Access Denied');}//$_G变量是程序的全局变量，为了使得程序更加高效，减少不必要的数据获取，所以程序特将经常需要用到的变量统一，放到$_G变量中，如用户登录信息、后台设置信息、服务器环境信息、客户端CooKies、数据缓存等都存放在G变量里面，在开发插件或者制作模板的时候只需要将G变量打印出来即可获得需要的信息是否在G变量里面。global $_G;loadcache('plugin');//$ps为支付的一些设置$ps = $_G['cache']['plugin']['achpay'];//引入函数文件require_once DISCUZ_ROOT.'source/plugin/achpay/require/function.php';$bdt = ($ps['passtime']>=0.5)?($ps['passtime']*3600):86400;$pd = $_G['timestamp'] - $bdt;$passtime = DB::query("UPDATE " . DB::table('achpay_log') . " SET status = '-1',payline='".$_G['timestamp']."' WHERE dateline < '".$pd."' AND payline='0'");//var_dump($passtime);//如果点击了删除订单按钮if(submitcheck('delsubmit')){    $formhash = addslashes($_GET['formhash']);    $delselect = $_GET['del'];    $fromurl = "action=plugins&operation=config&do=".$_GET['do']."&identifier=achpay&pmod=admin&uid=".$_GET['uid']."&startline=".$_GET['startline']."&endline=".$_GET['endline']."&status=".$_GET['status']."&page=".$_GET['page'];    if($formhash == FORMHASH){        empty($delselect) && cpmsg(lang('plugin/achpay', 'lang002'), $fromurl, 'error');        foreach($delselect as $delid){            achpay_del($delid);        }   }    cpmsg(lang('plugin/achpay', 'lang003'), $fromurl, 'succeed');}//如果点击了 补发积分并标记为已完成if(submitcheck('finishsubmit')){    $formhash = addslashes($_GET['formhash']);    $delselect = $_GET['del'];    $fromurl = "action=plugins&operation=config&do=".$_GET['do']."&identifier=achpay&pmod=admin&uid=".$_GET['uid']."&startline=".$_GET['startline']."&endline=".$_GET['endline']."&status=".$_GET['status']."&page=".$_GET['page'];    if($formhash == FORMHASH){        empty($delselect) && cpmsg(lang('plugin/achpay', 'lang004'), $fromurl, 'error');        foreach($delselect as $delid){            achpay_finish($delid);        }   }    cpmsg(lang('plugin/achpay', 'lang005'), $fromurl, 'succeed');}//如果点击了  标记为作废if(submitcheck('cancelsubmit')){    $formhash = addslashes($_GET['formhash']);    $delselect = $_GET['del'];    $fromurl = "action=plugins&operation=config&do=".$_GET['do']."&identifier=achpay&pmod=admin&uid=".$_GET['uid']."&startline=".$_GET['startline']."&endline=".$_GET['endline']."&status=".$_GET['status']."&page=".$_GET['page'];    if($formhash == FORMHASH){        empty($delselect) && cpmsg(lang('plugin/achpay', 'lang004'), $fromurl, 'error');        foreach($delselect as $delid){            achpay_cancel($delid);        }   }    cpmsg(lang('plugin/achpay', 'lang005'), $fromurl, 'succeed');}//如果点击了  等待支付if(submitcheck('waitsubmit')){    $formhash = addslashes($_GET['formhash']);    $delselect = $_GET['del'];    $fromurl = "action=plugins&operation=config&do=".$_GET['do']."&identifier=achpay&pmod=admin&uid=".$_GET['uid']."&startline=".$_GET['startline']."&endline=".$_GET['endline']."&status=".$_GET['status']."&page=".$_GET['page'];    if($formhash == FORMHASH){        empty($delselect) && cpmsg(lang('plugin/achpay', 'lang004'), $fromurl, 'error');        foreach($delselect as $delid){            achpay_wait($delid);        }   }    cpmsg(lang('plugin/achpay', 'lang005'), $fromurl, 'succeed');}//var_dump(!$_GET['editlogid']);exit;if(!$_GET['editlogid']){    $_GET['pagesize'] = intval($_GET['pagesize']);//    判断每页显示多少条 默认为20    $pagesize = ($_GET['pagesize']>0)?$_GET['pagesize']:20;//    获取订单总条数    $amount = achpay_getlistcount($_GET['uid'],$_GET['startline'],$_GET['endline'],$_GET['status']);//获取本周内实际收款    $total = achpay_counttotal($_GET['startline'],$_GET['endline'],$_GET['uid']);//获取分多少页    $pagecount = $amount ? (($amount < $pagesize) ? 1 : (($amount % $pagesize) ? ((int)($amount / $pagesize) + 1) : ($amount / $pagesize))) : 0;    $page = !empty($_GET['page']) ? max(1, intval($_GET['page'])) : 1;    $page = $page > $pagecount ? 1 : $page;    $startlimit = ($page - 1) * $pagesize; //根据分页和当前第几页 获取订单日志    $loglist = achpay_getlist($_GET['uid'],$_GET['startline'],$_GET['endline'], $_GET['status'],$startlimit,$pagesize);    $multipage = multi($amount, $pagesize, $page, "admin.php?action=plugins&operation=config&do=".$_GET['do']."&identifier=achpay&pmod=admin&uid=".$_GET['uid']."&startline=".$_GET['startline']."&endline=".$_GET['endline']."&status=".$_GET['status']."&pagesize=".$_GET['pagesize'], $pagecount);}else{    $loginfo = achpay_get($_GET['editlogid']);}!$_GET['startline'] && $_GET['startline']=date("Y-m-d 00:00",$_G['timestamp']-(86400*365));!$_GET['endline'] && $_GET['endline']=date("Y-m-d 23:59",$_G['timestamp']);include template("achpay:admin");?>